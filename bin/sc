#!/bin/sh

_appdir=`dirname $0`
TOP=`cd $_appdir/.. && pwd`
_conf="$1"

. $TOP/share/sc/scripts/common.sh
. $TOP/share/sc/scripts/carp.sh
. $TOP/share/sc/scripts/hosts.sh
. $TOP/share/sc/scripts/consul.sh
. $TOP/share/sc/scripts/fs.sh
. $TOP/share/sc/scripts/nomad.sh
. $TOP/share/sc/scripts/pot.sh
. $TOP/share/sc/scripts/traefik.sh

. $TOP/etc/sc/default.conf

CONF=/usr/local/etc/sc/sc.conf

load_conf() {
    local _conf

    _conf="$1"
    test ! -z "$_conf" && \
	test -f $_conf && \
	. $_conf
}

install() {
    parse_opts install "$@"

    if [ $? != 0 ]; then
	usage sc
	exit 1
    fi

    load_conf "$CONF"

    if [ ! -d /usr/local/bin ]; then
	run_cmd mkdir -p /usr/local/bin
    fi
    
    run_cmd cp $TOP/bin/sc /usr/local/bin 

    if [ ! -d /usr/local/etc/sc ]; then
	run_cmd mkdir -p /usr/local/etc/sc
    fi

    run_cmd cp $TOP/etc/sc/default.conf /usr/local/etc/sc
    run_cmd cp $CONF /usr/local/etc/sc 

    if [ ! -d /usr/local/share/sc ]; then
	run_cmd mkdir -p /usr/local/etc/share/sc
    fi

    run_cmd cp -Rf $TOP/share/sc/* /usr/local/etc/share/sc

    save_output /usr/local/etc/sc/sc.conf \
		cat $CONF && echo "NETIF=$NETIF"
    save_output /etc/rc.local echo /usr/local/bin/sc update && \
	echo /usr/local/bin/sc start
}

apply() {
    local _role _all_hosts _s

    parse_opts apply "$@"
    if [ $? != 0 ]; then
	usage sc
	exit 1
    fi

    echo "Using conf $CONF netif $NETIF "
    load_conf "$CONF"

    _all_hosts=`get_all_hosts`
    if ! name_in_list `hostname` $_all_hosts; then
	_role=none
    elif is_server; then
	_role=server
    else
	_role=client
    fi

    for _s in hosts fs carp consul nomad pot traefik; do
	if fn_defined "${_s}_apply"; then
	    eval "${_s}_apply $_role"
	    if [ $? != 0 ]; then
		echo "${_s}_apply $_role failed"
		exit 2
	    fi
	fi
    done

    echo "Host apply $_role success. "
    echo "Please reboot the system"
}

run_test() {
    local _tst

    _tst="$TOP/share/sc/testsuite/$1.sh"
    if [ -f "$_tst" ]; then
	. $_tst
	if fn_defined run_case ; then
	    run_case "$1"
	else
	    echo "no test entry function: run_case has been defined"
	    exit 2
	fi
    else
	echo "test case: $1($_tst) can not be found"
	exit 1
    fi
}

usage() {
    echo "usage: $1"
    echo "      $1 apply [ -c config ] [ -i netif ] [ -n ]"
    echo "      $1 test <testcase> (in testsuite directory)"
    echo "      usage (show this help)"
    echo
    echo "      1. config is the configuration file. see examples/conf/cluster.conf"
    echo "      2. netif is the network interface(default is em0)"
    echo "      3. -n turn on dry run mode(Just show what works which will be done)"
    return 1
}

start() {
    true
}

update() {
    true
}

action="$1"
shift

case $action in
    install)
	install "$@"
	;;
    update)
	update "$@"
	;;
    start)
	start "$@"
	;;
    apply)
	apply "$@"
	;;
    test)
	run_test "$@"
	;;
    *)
	usage sc
	;;
esac
