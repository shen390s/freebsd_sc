#!/bin/sh

APP=$(basename $0)
_appdir=$(dirname $0)
TOP=$(realpath $(cd $_appdir/.. && pwd))

action="$1"
shift

export APP TOP

. $TOP/share/sc/lib/funcs
. $TOP/share/sc/sv/svcs

build() {
    local _role _xfile

    _role="$1"
    shift 1
    _xfile="$TOP/share/sc/roles/$_role/config"

    if [ -f "$_xfile" ]; then
	. "$_xfile" 
	build_image "$_role"
    else
	cat <<EOF
$_xfile can not be found.
EOF
	exit 1
    fi
	
}

deploy() {
    local _role _job

    _role="$1"
    shift 1

    _job="$TOP/share/sc/jobs/${_role}.job"
    if [ -f "$_job" ]; then
	nomad run "$_job"
    else
	cat <<EOF
nomad job "$_job" can not be found
EOF
    fi
}

help() {
    cat <<EOF
usage: $APP command options
       commands:
            - build host
            - build jail roles(gitea/login/postix/seafile)
	    - deploy jail roles
EOF
}

case $action in
    build)
	build "$@"
	;;
    deploy)
	deploy "$@"
	;;
    help)
	help
	;;
    *)
	help
	;;
esac
    
